<UserControl x:Class="BulkEditor.UI.Controls.ModernDocumentTreeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:BulkEditor.UI.Controls"
             xmlns:vm="clr-namespace:BulkEditor.UI.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        
        <!-- Modern Expand/Collapse Button Style -->
        <Style x:Key="ModernExpanderToggleButton" TargetType="{x:Type ToggleButton}">
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Width" Value="20"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                        <Border Background="Transparent" Width="20" Height="20">
                            <Border Name="ExpandPath"
                                    Width="12" Height="12"
                                    Background="#2196F3"
                                    CornerRadius="6"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                                <TextBlock Name="ExpandIcon"
                                           Text="+"
                                           Foreground="White"
                                           FontWeight="Bold"
                                           FontSize="10"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="ExpandIcon" Property="Text" Value="âˆ’"/>
                                <Setter TargetName="ExpandPath" Property="Background" Value="#FF5722"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ExpandPath" Property="Background" Value="#1976D2"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Modern TreeViewItem Style -->
        <Style x:Key="ModernTreeViewItem" TargetType="{x:Type TreeViewItem}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Top"/>
            <Setter Property="Padding" Value="3"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TreeViewItem}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <Border Name="Bd"
                                    Grid.Row="0"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    Padding="{TemplateBinding Padding}"
                                    CornerRadius="4"
                                    Margin="2">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <ToggleButton Grid.Column="0"
                                                  Name="Expander"
                                                  Style="{StaticResource ModernExpanderToggleButton}"
                                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                  ClickMode="Press"
                                                  Margin="0,0,8,0"/>
                                    
                                    <ContentPresenter Grid.Column="1"
                                                      Name="PART_Header"
                                                      ContentSource="Header"
                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                </Grid>
                            </Border>
                            
                            <ItemsPresenter Grid.Row="1"
                                            Name="ItemsHost"
                                            Margin="20,0,0,0"/>
                        </Grid>
                        
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="false">
                                <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed"/>
                            </Trigger>
                            <Trigger Property="HasItems" Value="false">
                                <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="true">
                                <Setter TargetName="Bd" Property="Background" Value="#E3F2FD"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#2196F3"/>
                                <Setter TargetName="Bd" Property="BorderThickness" Value="1"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="true">
                                <Setter TargetName="Bd" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="false">
                                <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Document Header Template -->
        <DataTemplate x:Key="DocumentHeaderTemplate" DataType="{x:Type vm:ProcessingResultViewModel}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <TextBlock Text="{Binding DocumentTitle}" 
                               FontWeight="Bold" 
                               FontSize="14"
                               Foreground="#333333"/>
                    <TextBlock Text="{Binding DocumentPath}" 
                               FontSize="12"
                               Foreground="#666666"
                               Opacity="0.8"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Border Background="#4CAF50" 
                            CornerRadius="12" 
                            Padding="8,4"
                            Margin="4,0">
                        <TextBlock Text="{Binding Status}" 
                                   Foreground="White"
                                   FontSize="10"
                                   FontWeight="Bold"/>
                    </Border>
                    <TextBlock Text="{Binding ProcessedAt, StringFormat='Processed: {0:HH:mm:ss}'}" 
                               FontSize="10"
                               Foreground="#999999"
                               VerticalAlignment="Center"
                               Margin="8,0,0,0"/>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <!-- Processing Option Template -->
        <DataTemplate x:Key="ProcessingOptionTemplate" DataType="{x:Type vm:ProcessingOptionViewModel}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" 
                           Text="{Binding OptionName}"
                           FontWeight="Medium"
                           FontSize="13"
                           Foreground="#444444"
                           VerticalAlignment="Center"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding WasProcessed, Mode=OneWay}"
                              IsEnabled="False"
                              VerticalAlignment="Center"
                              Margin="8,0"/>
                    <Border Background="#E0E0E0" 
                            CornerRadius="10" 
                            Padding="6,2"
                            Visibility="{Binding HasChanges, Converter={StaticResource BoolToVisConverter}}">
                        <TextBlock Text="{Binding ChangeCount, StringFormat='{}{0} changes'}" 
                                   FontSize="10"
                                   Foreground="#666666"/>
                    </Border>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <!-- Processing Change Template -->
        <DataTemplate x:Key="ProcessingChangeTemplate" DataType="{x:Type vm:ProcessingChangeViewModel}">
            <Border Background="#FAFAFA" 
                    BorderBrush="#E0E0E0" 
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="12"
                    Margin="0,2">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Current Title:" FontWeight="Bold" FontSize="11"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding CurrentTitle}" FontSize="11" TextWrapping="Wrap"/>
                    
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Nuxeo Title:" FontWeight="Bold" FontSize="11" Margin="0,4,0,0"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding NuxeoTitle}" FontSize="11" TextWrapping="Wrap" Margin="0,4,0,0"/>
                    
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Content ID:" FontWeight="Bold" FontSize="11" Margin="0,4,0,0"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ContentId}" FontSize="11" Margin="0,4,0,0"/>
                    
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Change:" FontWeight="Bold" FontSize="11" Margin="0,4,0,0"/>
                    <Border Grid.Row="3" Grid.Column="1" 
                            Background="#2196F3" 
                            CornerRadius="12" 
                            Padding="8,2"
                            HorizontalAlignment="Left"
                            Margin="0,4,0,0">
                        <TextBlock Text="{Binding ChangeType}" 
                                   Foreground="White"
                                   FontSize="10"
                                   FontWeight="Bold"/>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Hierarchical Data Template -->
        <HierarchicalDataTemplate DataType="{x:Type vm:ProcessingResultViewModel}"
                                  ItemsSource="{Binding ProcessingOptions}">
            <ContentPresenter ContentTemplate="{StaticResource DocumentHeaderTemplate}"/>
        </HierarchicalDataTemplate>

        <HierarchicalDataTemplate DataType="{x:Type vm:ProcessingOptionViewModel}"
                                  ItemsSource="{Binding Changes}">
            <ContentPresenter ContentTemplate="{StaticResource ProcessingOptionTemplate}"/>
        </HierarchicalDataTemplate>

        <DataTemplate DataType="{x:Type vm:ProcessingChangeViewModel}">
            <ContentPresenter ContentTemplate="{StaticResource ProcessingChangeTemplate}"/>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" 
                Background="#F5F5F5" 
                Padding="16,12"
                BorderBrush="#E0E0E0"
                BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Processing Results"
                               FontSize="18"
                               FontWeight="Medium"
                               VerticalAlignment="Center"/>
                    <Button Content="Expand All"
                            Click="ExpandAllButton_Click"
                            Background="Transparent"
                            BorderBrush="#2196F3"
                            BorderThickness="1"
                            Foreground="#2196F3"
                            Padding="8,4"
                            Margin="16,0,8,0"
                            FontSize="12"/>
                    <Button Content="Collapse All"
                            Click="CollapseAllButton_Click"
                            Background="Transparent"
                            BorderBrush="#FF5722"
                            BorderThickness="1"
                            Foreground="#FF5722"
                            Padding="8,4"
                            FontSize="12"/>
                </StackPanel>
                
                <TextBlock Grid.Column="1"
                           Text="{Binding ProcessingResults.Count, StringFormat='Total: {0} documents'}"
                           FontSize="14"
                           Foreground="#757575"
                           VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- TreeView -->
        <TreeView Grid.Row="1"
                  Name="DocumentTreeView"
                  ItemsSource="{Binding ProcessingResults}"
                  Background="White"
                  BorderThickness="0"
                  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  Visibility="{Binding HasProcessingResults, Converter={StaticResource BoolToVisConverter}}">
            <TreeView.ItemContainerStyle>
                <Style TargetType="{x:Type TreeViewItem}" BasedOn="{StaticResource ModernTreeViewItem}">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                </Style>
            </TreeView.ItemContainerStyle>
        </TreeView>

        <!-- Empty State -->
        <Grid Grid.Row="1">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasProcessingResults}" Value="False">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Opacity="0.6">
                <TextBlock Text="ðŸ“„"
                           FontSize="48"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,16"/>
                <TextBlock Text="No processing results available"
                           FontSize="16"
                           FontWeight="Medium"
                           HorizontalAlignment="Center"
                           Foreground="#757575"/>
                <TextBlock Text="Process documents to see detailed results here"
                           FontSize="14"
                           HorizontalAlignment="Center"
                           Foreground="#999999"
                           Margin="0,4,0,0"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>